<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>MVC Applications - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter6/mvc/">
      
      
        <meta name="author" content="Adrian Hall">
      
    
    <meta property="og:url" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter6/mvc/">
    <meta property="og:title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta property="og:image" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter6/mvc//../../">
    <meta name="apple-mobile-web-app-title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-a422ff04cc.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Chapter 6 - Combining Web and Mobile Apps <i class="icon icon-link"></i>
              
            
          </span>
        
        MVC Applications
      </div>
    </div>
    
      
      <div class="button button-twitter" role="button" aria-label="Twitter">
        <a href="https://twitter.com/FizzyInTheHall" title="@FizzyInTheHall on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
      </div>
    
    
      
      <div class="button button-github" role="button" aria-label="GitHub">
        <a href="https://github.com/adrianhall" title="@adrianhall on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
      </div>
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>
          Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          <span class="version">
            
          </span>
        </strong>
        
          <br>
          adrianhall/develop-mobile-apps-with-csharp-and-azure
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Getting Started" href="../..">
      Getting Started
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Chapter 1 - Introduction</span>
    <ul>
      
        
  <li>
    <a class="" title="Your First App - PC Edition" href="../../chapter1/firstapp_pc/">
      Your First App - PC Edition
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Your First App - Mac Edition" href="../../chapter1/firstapp_mac/">
      Your First App - Mac Edition
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 2 - Authentication</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter2/authconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Authentication in the Backend" href="../../chapter2/backend/">
      Authentication in the Backend
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Enterprise Authentication" href="../../chapter2/enterprise/">
      Enterprise Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Social Authentication" href="../../chapter2/social/">
      Social Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Debugging Authentication" href="../../chapter2/debugging/">
      Debugging Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Custom Authentication" href="../../chapter2/custom/">
      Custom Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Claims and Authorization" href="../../chapter2/authorization/">
      Claims and Authorization
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Tokens in Real Apps" href="../../chapter2/realworld/">
      Tokens in Real Apps
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Best Practices" href="../../chapter2/bestpractices/">
      Best Practices
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 3 - Data Access and Offline Sync</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter3/dataconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Implementing Table Controllers" href="../../chapter3/server/">
      Implementing Table Controllers
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Data Projection and Queries" href="../../chapter3/projection/">
      Data Projection and Queries
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Mobile Client" href="../../chapter3/client/">
      The Mobile Client
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Relationships" href="../../chapter3/relationships/">
      Relationships
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Domain Manager" href="../../chapter3/domainmgr/">
      The Domain Manager
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 4 - Server Side Code</span>
    <ul>
      
        
  <li>
    <a class="" title="Options for Server Code" href="../../chapter4/options/">
      Options for Server Code
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Custom HTTP Endpoints" href="../../chapter4/custom/">
      Custom HTTP Endpoints
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="WebJobs" href="../../chapter4/webjobs/">
      WebJobs
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Functions" href="../../chapter4/functions/">
      Functions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Recipes" href="../../chapter4/recipes/">
      Recipes
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 5 - Push Notifications</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter5/concepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Android Push" href="../../chapter5/android/">
      Android Push
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="iOS Push" href="../../chapter5/ios/">
      iOS Push
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Windows Push" href="../../chapter5/windows/">
      Windows Push
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Push Recipes" href="../../chapter5/recipes/">
      Push Recipes
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 6 - Combining Web and Mobile Apps</span>
    <ul>
      
        
  <li>
    <a class="current" title="MVC Applications" href="./">
      MVC Applications
    </a>
    
      
      
        <ul>
          
            <li class="anchor">
              <a title="Sharing the Database" href="#sharing-the-database">
                Sharing the Database
              </a>
            </li>
          
            <li class="anchor">
              <a title="Sharing Authentication" href="#sharing-authentication">
                Sharing Authentication
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
        
  <li>
    <a class="" title="jQuery Applications" href="../jquery/">
      jQuery Applications
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Angular Applications" href="../angular/">
      Angular Applications
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="React Applications" href="../react/">
      React Applications
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 7 - Other Useful Services</span>
    <ul>
      
        
  <li>
    <a class="" title="Azure Search" href="../../chapter7/search/">
      Azure Search
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Media Services" href="../../chapter7/media/">
      Media Services
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Real-time Notifications" href="../../chapter7/realtime/">
      Real-time Notifications
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 8 - Developing An App</span>
    <ul>
      
        
  <li>
    <a class="" title="The Development Environment" href="../../chapter8/developing/">
      The Development Environment
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Testing your Application" href="../../chapter8/testing/">
      Testing your Application
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 9 - Going to Production</span>
    <ul>
      
        
  <li>
    <a class="" title="Repeatable Deployments" href="../../chapter9/arm/">
      Repeatable Deployments
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Safe Deployments" href="../../chapter9/appsvc/">
      Safe Deployments
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Monitoring" href="../../chapter9/monitoring/">
      Monitoring
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Troubleshooting" href="../../chapter9/troubleshooting/">
      Troubleshooting
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Xamarin Forms Tips" href="../../xamarin_tips/">
      Xamarin Forms Tips
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Android Developer Notes" href="../../android_appendix/">
      Android Developer Notes
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Visual Studio Extensions" href="../../vs_extensions/">
      Visual Studio Extensions
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="References" href="../../references/">
      References
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Credits" href="../../credits/">
      Credits
    </a>
    
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
              
              <li>
                <a href="https://twitter.com/FizzyInTheHall" target="_blank" title="@FizzyInTheHall on Twitter">
                  @FizzyInTheHall on Twitter
                </a>
              </li>
            
            
              
              <li>
                <a href="https://github.com/adrianhall" target="_blank" title="@adrianhall on GitHub">
                  @adrianhall on GitHub
                </a>
              </li>
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
            <h1>MVC Applications</h1>
          
          <p>At some point, you will likely want to pair your mobile application with a web interface.  This may be because you have a simplified
mobile app whereas you may have a more fully featured app within the web.  For example,  I see this design featured prominently in
fitness apps.  The mobile app is a news feed and recording device, whereas the web interface contains all the fitness analytics.  You
may also have some sort of administrative interface that provides an alternate view of the data.</p>
<p>Whatever the reason you decide to support web and mobile together, you will need to convert your Azure Mobile App backend to a fully-fledged
ASP.NET MVC application.  Fortunately, the process of merging Azure Mobile Apps with an existing ASP.NET MVC application is simple.  Doing
the reverse (merging MVC into Azure Mobile Apps) is considerably more complex.</p>
<p>Start by creating a new ASP.NET application with File -&gt; New Project.  Select the <strong>ASP.NET Web Application (.NET Framework)</strong> project
template.  Then select th <strong>MVC</strong> template.  Change the Authentication to <strong>No Authentication</strong>.</p>
<p><img alt="" src="../img/new-project.png" /></p>
<p>Click <strong>OK</strong> to create the project.  Run your project to ensure it is working correctly.</p>
<div class="admonition info">
<p class="admonition-title">Why is merging MVC into Azure Mobile Apps so hard?</p>
<p>ASP.NET requires a large number of NuGet packages to implement MVC.  These are provided for you when you start from the
appropriate template, but you will need to add them yourself when you start from the Azure Mobile Apps template.</p>
</div>
<p>Now that you have an MVC project, let's add Azure Mobile Apps to it.  Start by adding the following two NuGet packages to your
project:</p>
<ul>
<li>Microsoft.Azure.Mobile.Server.Quickstart</li>
<li>Mirosoft.Owin.Host.SystemWeb</li>
</ul>
<p>The Quickstart NuGet package contains dependencies for all the other Azure Mobile Apps SDK requirements.  If you want the
big long list instead, add the following:</p>
<ul>
<li>AutoMapper</li>
<li>EntityFramework</li>
<li>Microsoft.AspNet.WebApi.Client</li>
<li>Microsoft.AspNet.WebApi.Core</li>
<li>Microsoft.AspNet.WebApi.Owin</li>
<li>Microsoft.Azure.Mobile.Server</li>
<li>Microsoft.Azure.Mobile.Server.Authentication</li>
<li>Microsoft.Azure.Mobile.Server.Notifications</li>
<li>Microsoft.Azure.NotificationHubs</li>
<li>Microsoft.Data.Edm</li>
<li>Microsoft.Owin</li>
<li>Microsoft.Owin.Security</li>
<li>Microsoft.WindowsAzure.ConfigurationManager</li>
<li>Owin</li>
<li>System.IdentityModel.Tokens.Jwt</li>
<li>System.Spatial</li>
</ul>
<p>Using the Quickstart package is a serious time saver over having to type in 16 package names.  The SystemWeb package enables
the use of the Owin Startup.cs class.  This is used to bootstrap the Azure Mobile Apps configuration.</p>
<div class="admonition tip">
<p class="admonition-title">Upgrading to .NET 4.6</p>
<p>If you want to run your ASP.NET service under .NET Framework 4.6, you can upgrade just about everything.  However, the
<code>System.IdentityModel.Tokens.Jwt</code> package should not be upgraded - leave it on the latest v4.x release.  In addition, do
not upgrade <code>AutoMapper</code> beyond v3.3.1 if you are using the <code>MappedEntityDomainManager</code> class.</p>
</div>
<p>You can then copy the the following files from your original Azure Mobile Apps server project to the new project.</p>
<ul>
<li><code>App_Start\Startup.MobileApp.cs</code></li>
<li><code>Controllers\*.cs</code></li>
<li><code>DataObjects\*.cs</code></li>
<li><code>Models\MobileServiceContext.cs</code></li>
</ul>
<p>Finally, adjust or create the <code>Startup.cs</code> file as follows:</p>
<pre><code class="csharp">using Microsoft.Owin;
using Owin;

[assembly: OwinStartup(typeof(Backend.Startup))]
namespace Backend
{
    public partial class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            ConfigureMobileApp(app);
        }
    }
}
</code></pre>

<p>Note the addition of the <code>ConfigureMobileApp()</code> call.  If you are starting from the suggested template, this file does not exist and you
will need to create it.</p>
<p>Finally, you must update the <code>Web.config</code> file.  Firstly, in the <code>&lt;configSections&gt;</code> tag, add the following to support Entity Framework:</p>
<pre><code class="xml">    &lt;section name=&quot;entityFramework&quot; type=&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot; requirePermission=&quot;false&quot; /&gt;
</code></pre>

<p>Add the following <code>&lt;connectionStrings&gt;</code> section:</p>
<pre><code class="xml">  &lt;connectionStrings&gt;
    &lt;add name=&quot;MS_TableConnectionString&quot; connectionString=&quot;Data Source=(localdb)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\aspnet-Backend.mdf;Initial Catalog=aspnet-Backend-20160720081828;Integrated Security=True;MultipleActiveResultSets=True&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt;
  &lt;/connectionStrings&gt;
</code></pre>

<p>Finally, add the following entries to the <code>&lt;appSettings&gt;</code> section:</p>
<pre><code class="xml">  &lt;appSettings&gt;
    &lt;add key=&quot;webpages:Enabled&quot; value=&quot;false&quot; /&gt;
    &lt;add key=&quot;PreserveLoginUrl&quot; value=&quot;true&quot; /&gt;
    &lt;add key=&quot;MS_SigningKey&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;EMA_RuntimeUrl&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;MS_NotificationHubName&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;SigningKey&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;ValidAudience&quot; value=&quot;https://chapter6.azurewebsites.net/&quot; /&gt;
    &lt;add key=&quot;ValidIssuer&quot; value=&quot;https://chapter6.azurewebsites.net/&quot; /&gt;
  &lt;/appSettings&gt;
</code></pre>

<p>The first appSetting key should already be present.  These changes can be copied from the <code>Web.config</code> file from your Azure Mobile Apps project.</p>
<h2 id="sharing-the-database">Sharing the Database<a class="headerlink" href="#sharing-the-database" title="Permanent link">&para;</a></h2>
<p>Underneath the covers, Azure Mobile Apps uses <a href="https://www.asp.net/entity-framework">EntityFramework</a> to access the database.  It requires certain adjustments to the models,
as we discussed in [Chapter 3].  However, you can still use the same Entity Framework context to access the database.  There are some
caveats that must be followed, however:</p>
<ul>
<li>Inserts must set the fields that are not managed by the database (such as <code>Id</code>).</li>
<li>Deletes must set the <code>Deleted</code> column if using Soft Delete, instead of directly deleting records.</li>
</ul>
<p>Before you get started, you have to enable EF code-first migrations.  If you don't, you will get an error about a duplicate clustered index
in your application for each table based on EntityData.  To enable migrations:</p>
<ol>
<li>Open the Package Manager Console in Visual Studio</li>
<li>Run <code>Enable-Migrations</code></li>
<li>
<p>Adjust the created <code>Migrations\Configuration.cs</code> constructor as follows:</p>
<p><code>csharp
    public Configuration()
    {
        AutomaticMigrationsEnabled = false;
        SetSqlGenerator("System.Data.SqlClient", new EntityTableSqlGenerator());
    }</code></p>
</li>
<li>
<p>In your <code>App_Start\Startup.MobileApp.cs</code>, comment out or remove your  <code>Database.SetInitializer()</code> call, and replace with:</p>
<p><code>csharp
var migrator = new DbMigrator(new Migrations.Configuration());
migrator.Update();</code></p>
<p>You can also remove the MobileServiceInitializer class in the same file, if you wish.</p>
</li>
<li>
<p>Run <code>Add-Migration initial</code> in the Package Manager Console.</p>
</li>
</ol>
<p>This is an abbreviated set of instructions from our work in <a href="../../chapter3/server/">Chapter 3</a>.</p>
<p>As an example, let's create a default view for handling our TodoItem controller.  In MVC, you need a Model, View and Controller class.  The
Model will be handled by our existing <code>DataObjects\TodoItem.cs</code> class.  The Controller and View will be new classes.  Let's take a look at
the replacement <code>HomeController.cs</code> class first:</p>
<pre><code class="csharp">using System.Linq;
using System.Web.Mvc;
using Backend.Models;

namespace Backend.Controllers
{
    public class HomeController : Controller
    {
        private MobileServiceContext context;

        public HomeController()
        {
            context = new MobileServiceContext();
        }

        public ActionResult Index()
        {
            var list = context.TodoItems.ToList();
            return View(list);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; Create([Bind(Include = &quot;Text&quot;)]TodoItem item)
        {
            try
            {
                if (ModelState.IsValid)
                {
                    item.Id = Guid.NewGuid().ToString(&quot;N&quot;);
                    context.TodoItems.Add(item);
                    await context.SaveChangesAsync();
                }
            }
            catch (DataException)
            {
                ModelState.AddModelError(&quot;&quot;, &quot;Unable to save changes.&quot;);
            }
            return RedirectToAction(&quot;Index&quot;);
        }
    }
}
</code></pre>

<p>I am using the existing MobileServiceContext as the Entity Framework context.  The list of tasks is taken directly from the <code>DbSet&lt;&gt;</code>
that was established for the mobile backend table controller.  I also have a method for creating a new todo item within the controller.
If you look for a tutorial on implementing CRUD in ASP.NET MVC, it's likely you will see code similar to this.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>I've removed some additional views from this backend (About and Contact) plus the links in the layout partial view.  This is just
to make the code cleaner.  You can leave them in if you desire.</p>
</div>
<p>The view in <code>Views\Home\Index.cshtml</code> is similarly changed:</p>
<pre><code class="html">@{
    ViewBag.Title = &quot;Home Page&quot;;
}
@model IEnumerable&lt;Backend.DataObjects.TodoItem&gt;

&lt;div class=&quot;row&quot; style=&quot;margin-top: 8px;&quot;&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;col-md-10&quot;&gt;
        @using (Html.BeginForm(&quot;Create&quot;, &quot;Home&quot;, FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            &lt;input type=&quot;text&quot; name=&quot;Text&quot; placeholder=&quot;Enter TodoItem Text...&quot;/&gt;
            &lt;input type=&quot;submit&quot; value=&quot;Add Todo Item&quot;/&gt;
        }
    &lt;/div&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;row&quot; style=&quot;margin-top: 8px;&quot;&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;col-md-10&quot;&gt;
        &lt;div class=&quot;table-responsive&quot;&gt;
            &lt;table class=&quot;table table-striped table-bordered table-hover table-condensed&quot;&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;#&lt;/th&gt;
                        &lt;th&gt;Text&lt;/th&gt;
                        &lt;th&gt;Complete&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    @foreach (var item in Model)
                    {
                        &lt;tr&gt;
                            &lt;td&gt;@Html.DisplayFor(modelItem =&gt; item.Id)&lt;/td&gt;
                            &lt;td&gt;@Html.DisplayFor(modelItem =&gt; item.Text)&lt;/td&gt;
                            &lt;td&gt;@Html.DisplayFor(modelItem =&gt; item.Complete)&lt;/td&gt;
                        &lt;/tr&gt;
                    }
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>The HTML classes are from <a href="http://getbootstrap.com/">Bootstrap</a> - a common CSS framework.  The first row div encapsulates the form for adding a new todo item,
and the second row div encapsulates the list.  If you enter some text into the box and click the submit button, it will be added to the
database.</p>
<h2 id="sharing-authentication">Sharing Authentication<a class="headerlink" href="#sharing-authentication" title="Permanent link">&para;</a></h2>
<p>As one would suspect, <a href="../../chapter2/authconcepts/">setting up App Service Authentication</a>, then adding an <code>[Authorize]</code> attribute to the <code>HomeController</code> is a good
starting point for making our application authenticated.  However, it isn't enough.  If you just do this, you will got something like the
following:</p>
<p><img alt="" src="../img/failed-auth.PNG" /></p>
<p>In order to properly capture the login flow, we have to redirect a missing authentication to the appropriate authentication endpoint.  In
ASP.NET, this functionality is configured within the <code>Web.config</code> file.  Locate the <code>&lt;system.web&gt;</code> section and add the following:</p>
<pre><code class="xml">  &lt;system.web&gt;
    &lt;compilation debug=&quot;true&quot; targetFramework=&quot;4.5.2&quot;/&gt;
    &lt;httpRuntime targetFramework=&quot;4.5.2&quot;/&gt;
    &lt;authentication mode=&quot;Forms&quot;&gt;
      &lt;forms loginUrl=&quot;/.auth/login/aad&quot; timeout=&quot;2880&quot;/&gt;
    &lt;/authentication&gt;
  &lt;/system.web&gt;
</code></pre>

<p>The <code>&lt;compilation&gt;</code> and <code>&lt;httpRuntime&gt;</code> values should already be present.  The <code>&lt;authentication&gt;</code> section is new.  Once you deploy this code
to Azure App Service, you will be redirected to your authentication provider.  Once the authentication process is complete, you will receive
a page indicating successful authentication, with a link back to the website.</p>
<div class="admonition warn">
<p class="admonition-title">Use a private browsing window for testing</p>
<p>One of the major problems with using Azure AD for authentication as a developer is that the Azure Portal authentication uses the same
providers.  This can cause problems in your app.  Always use a private browsing window and/or a different browser for testing your code.</p>
</div>
<h3 id="using-anti-forgery-tokens">Using Anti-Forgery Tokens<a class="headerlink" href="#using-anti-forgery-tokens" title="Permanent link">&para;</a></h3>
<p>One of the gotchas for using ASP.NET MVC with Azure App Service Authentication is that the Anti-Forgery Token no longer works as advertised.  If
you try to use the anti-forgery token on POST operations (and the associated <code>[ValidateAntiForgeryToken]</code> within your controller), you will receive
the following exception:</p>
<blockquote>
<p>A claim of type 'http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier' or 'http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider' was not present on the provided ClaimsIdentity. To enable anti-forgery token support with claims-based authentication, please verify that the configured claims provider is providing both of these claims on the ClaimsIdentity instances it generates. If the configured claims provider instead uses a different claim type as a unique identifier, it can be configured by setting the static property AntiForgeryConfig.UniqueClaimTypeIdentifier.</p>
</blockquote>
<p>Unfortunately, the logic here is wrong.  Check the <a href="https://github.com/mono/aspnetwebstack/blob/6248bfd24c31356e75a31c1b1030d4d96f669a6a/src/System.Web.WebPages/Helpers/AntiXsrf/ClaimUidExtractor.cs#L78">source code</a> and you will see that both listed claims must be present to not throw
the exception.  The Azure App Service Authentication claims do not include the <code>identityprovider</code> claim.</p>
<p>So much for the bug.  With the advent of .NET Core, I do not expect this bug to be fixed.  The workaround is to explicitly specify the identifier
to use somewhere in your application startup:</p>
<pre><code class="csharp">AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;
</code></pre>

<p>I place this in the MVC specific <code>App_Start\RouteConfig.cs</code> file:</p>
<pre><code class="csharp">namespace Backend
{
    public class RouteConfig
    {
        public static void RegisterRoutes(RouteCollection routes)
        {
            routes.IgnoreRoute(&quot;{resource}.axd/{*pathInfo}&quot;);

            routes.MapRoute(
                name: &quot;Default&quot;,
                url: &quot;{controller}/{action}/{id}&quot;,
                defaults: new { controller = &quot;Home&quot;, action = &quot;Index&quot;, id = UrlParameter.Optional }
            );

            AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;
        }
    }
}
</code></pre>

<p>This will force the use of the (singular) claim rather than requiring both claims to be present, thus allowing you to use the anti-forgery token.</p>
<!-- Images -->

<!-- Links -->
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../../chapter5/recipes/" title="Push Recipes">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Push Recipes
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../jquery/" title="jQuery Applications">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                jQuery Applications
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = 'adrianhall/develop-mobile-apps-with-csharp-and-azure';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
      <script src="../../js/highlight.pack.js"></script>
    
    
  </body>
</html>