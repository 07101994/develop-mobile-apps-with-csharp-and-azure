<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>File Synchronization - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/filesync/">
      
      
        <meta name="author" content="Adrian Hall">
      
    
    <meta property="og:url" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/filesync/">
    <meta property="og:title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta property="og:image" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/filesync//../../">
    <meta name="apple-mobile-web-app-title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-a422ff04cc.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Chapter 4 - File Management <i class="icon icon-link"></i>
              
            
          </span>
        
        File Synchronization
      </div>
    </div>
    
      
      <div class="button button-twitter" role="button" aria-label="Twitter">
        <a href="https://twitter.com/FizzyInTheHall" title="@FizzyInTheHall on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
      </div>
    
    
      
      <div class="button button-github" role="button" aria-label="GitHub">
        <a href="https://github.com/adrianhall" title="@adrianhall on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
      </div>
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>
          Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          <span class="version">
            
          </span>
        </strong>
        
          <br>
          adrianhall/develop-mobile-apps-with-csharp-and-azure
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Getting Started" href="../..">
      Getting Started
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Chapter 1 - Introduction</span>
    <ul>
      
        
  <li>
    <a class="" title="Your First App - PC Edition" href="../../chapter1/firstapp_pc/">
      Your First App - PC Edition
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Your First App - Mac Edition" href="../../chapter1/firstapp_mac/">
      Your First App - Mac Edition
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 2 - Authentication</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter2/authconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Authentication in the Backend" href="../../chapter2/backend/">
      Authentication in the Backend
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Enterprise Authentication" href="../../chapter2/enterprise/">
      Enterprise Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Social Authentication" href="../../chapter2/social/">
      Social Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Debugging Authentication" href="../../chapter2/debugging/">
      Debugging Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Custom Authentication" href="../../chapter2/custom/">
      Custom Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Claims and Authorization" href="../../chapter2/authorization/">
      Claims and Authorization
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Tokens in Real Apps" href="../../chapter2/realworld/">
      Tokens in Real Apps
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Best Practices" href="../../chapter2/bestpractices/">
      Best Practices
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 3 - Data Access and Offline Sync</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter3/dataconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Implementing Table Controllers" href="../../chapter3/server/">
      Implementing Table Controllers
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Data Projection and Queries" href="../../chapter3/projection/">
      Data Projection and Queries
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Mobile Client" href="../../chapter3/client/">
      The Mobile Client
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Relationships" href="../../chapter3/relationships/">
      Relationships
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Domain Manager" href="../../chapter3/domainmgr/">
      The Domain Manager
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 4 - File Management</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../concepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Dealing with Files" href="../files/">
      Dealing with Files
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="File Synchronization" href="./">
      File Synchronization
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Configuring the Mobile Backend" href="#configuring-the-mobile-backend">
                Configuring the Mobile Backend
              </a>
            </li>
          
            <li class="anchor">
              <a title="Developing the Mobile Client" href="#developing-the-mobile-client">
                Developing the Mobile Client
              </a>
            </li>
          
            <li class="anchor">
              <a title="Handling Authorization in File Sync" href="#handling-authorization-in-file-sync">
                Handling Authorization in File Sync
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Push Notifications" href="../../push/">
      Push Notifications
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Server Side Code" href="../../custom/">
      Server Side Code
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Media Services" href="../../media/">
      Media Services
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Leveraging Search" href="../../search/">
      Leveraging Search
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Web and Mobile Apps" href="../../combined/">
      Web and Mobile Apps
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="The Development Environment" href="../../developing/">
      The Development Environment
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Testing your Application" href="../../testing/">
      Testing your Application
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Troubleshooting" href="../../troubleshooting/">
      Troubleshooting
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Going to Production" href="../../production/">
      Going to Production
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Xamarin Forms Tips" href="../../xamarin_tips/">
      Xamarin Forms Tips
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Android Developer Notes" href="../../android_appendix/">
      Android Developer Notes
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="References" href="../../references/">
      References
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Credits" href="../../credits/">
      Credits
    </a>
    
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
              
              <li>
                <a href="https://twitter.com/FizzyInTheHall" target="_blank" title="@FizzyInTheHall on Twitter">
                  @FizzyInTheHall on Twitter
                </a>
              </li>
            
            
              
              <li>
                <a href="https://github.com/adrianhall" target="_blank" title="@adrianhall on GitHub">
                  @adrianhall on GitHub
                </a>
              </li>
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="file-sync-with-azure-mobile-apps">File Sync with Azure Mobile Apps<a class="headerlink" href="#file-sync-with-azure-mobile-apps" title="Permanent link">&para;</a></h1>
<div class="admonition warn">
<p class="admonition-title">Section In Progress</p>
<p>This section is a work in progress.  It is not complete and may contain errors.  Do not
rely on the information in this section.</p>
</div>
<p>There are a couple of issues that the file management presented in the last section doesn't
handle.  The first issue is associated metadata.  If you are producing a picture album app, for
example, you will want to know what album the picture is in, how you have tagged the picture
and so on.  This associated metadata can be held in a table.  You do not have a direct
association between the file that has been uploaded and the metadata about the picture.
The second issue is offline sync.  The files are always retrieved from the server no matter
how many times you request them.  File-level caching is easy to implement but requires you
to maintain the list of files separately.  That brings us back to the associated metadata.</p>
<p>Azure Mobile Apps has a feature in the .NET library called <em>File Sync</em>.  Files are associated
with database records and synced alongside those database records.  The associated files can
be stored in anything (I recommend Azure Blob Storage, just like before) in any format and
any directory structure that you deem appropriate.  We will be producing a SAS token for
each file as it is synced.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>File Sync is in <strong>PREVIEW</strong> at this time and is available only for the .NET SDK.  You
can follow the development at <a href="https://github.com/Azure/azure-mobile-apps-net-files-client">the GitHub repository</a> for the SDK.  I used the <a href="http://www.nuget.org/packages/Microsoft.Azure.Mobile.Client.Files/1.0.0-beta-2">v1.0.0 beta-2</a>
release of the Files SDK for this chapter.</p>
</div>
<p>Because Azure Mobile Apps File Sync support is in preview, there may be changes between the
release noted here and the final release.  There may also be bugs in the software.</p>
<p>Developing a File Sync solution is in two parts: a backend portion that generates the necessary
SAS tokens.  Most of the development is done on the mobile client side.  I am going to assume
that you have <a href="../concepts/#create-storage-acct">connected an Azure Storage account</a> to your mobile backend during this walkthrough.</p>
<h2 id="configuring-the-mobile-backend">Configuring the Mobile Backend<a class="headerlink" href="#configuring-the-mobile-backend" title="Permanent link">&para;</a></h2>
<p>File Sync requires three additional HTTP endpoints.  The endpoints are all based on the record that the
files are associated with.  This is represented by the HTTP endpoint <code>/tables/{table}/{id}</code>, where <code>{table}</code>
is the name of the table and <code>{id}</code> is the Id field for the record.</p>
<ul>
<li><strong>POST /tables/{table}/{id}/StorageToken</strong></li>
</ul>
<p>When uploading a new file during file sync operations, we need to get a Storage Token to access
  that file.  This endpoint is called to generate the file.  It will look remarkably similar to the
  StorageToken endpoint we developed in the [last section].</p>
<ul>
<li><strong>GET /tables/{table}/{id}/MobileServiceFiles</strong></li>
</ul>
<p>We need to obtain a list of files to synchronize during the file sync process.</p>
<ul>
<li><strong>DELETE /tables/{table}/{id}/MobileServiceFiles/{filename}</strong></li>
</ul>
<p>When we delete a file from the cache on the mobile client, this endpoint is called to remove the file on the
  server during the sync operation.</p>
<p>When file are synchronized, the entire file is uploaded or downloaded directly to Azure Storage.  The
Azure Mobile Apps Files SDK for the server has default versions of these routines.  To implement them:</p>
<ol>
<li>
<p>Add the <strong>Microsoft.Azure.Mobile.Server.Files</strong> NuGet package to your backend project.  You will need
   to use the <em>Include prerelease</em> checkbox to find this package as it is still in preview.</p>
</li>
<li>
<p>Ensure that your <code>Startup.MobileApp.cs</code> contains the <code>MapHttpAttributeRoutes()</code> step:</p>
<p>```csharp
public static void ConfigureMobileApp(IAppBuilder app)
{
    var config = new HttpConfiguration();</p>
<pre><code>// Register the StorageController routes
config.MapHttpAttributeRoutes();

new MobileAppConfiguration()
    .UseDefaultConfiguration()
    .ApplyTo(config);
</code></pre>
<p>```</p>
</li>
<li>
<p>Add a <code>StorageController</code> for each <code>TableController</code> that you use.</p>
<p>```csharp
[MobileAppController]
public class TodoItemStorageController : StorageController<TodoItem>
{
    [HttpPost]
    [Route("tables/TodoItem/{id}/StorageToken")]
    public async Task<HttpResponseMessage> StorageTokenAsync(string id, StorageTokenRequest value)
        =&gt; Request.CreateResponse(await GetStorageTokenAsync(id, value));</p>
<pre><code>[HttpGet]
[Route("tables/TodoItem/{id}/MobileServiceFiles")]
public async Task&lt;HttpResponseMessage&gt; GetFilesAsync(string id)
    =&gt; Request.CreateResponse(await GetRecordFilesAsync(id));

[HttpDelete]
[Route("tables/TodoItem/{id}/MobileServiceFiles/{name}")]
public Task DeleteAsync(string id, string name) =&gt; base.DeleteFileAsync(id, name);
</code></pre>
<p>}
```</p>
</li>
</ol>
<p>You must add a <code>StorageController</code> for each <code>TableController</code> that you are using.  The File Sync
process can provide sync capabilities for any file controller and it will attempt to sync any
associated files when used with the default settings.</p>
<p>Just as with the <code>TableController</code>, we can adjust the requests to handle per-user authorization.
The default version of <code>StorageController</code> does the same amount of authorization as the default
version of the <code>TableController</code> - none at all.  Our <code>TodoItemController</code> implements per-user
authorization.  We may want to model that in the storage controller as well.</p>
<p>Checking for a valid authorization token is the same.  Add an <code>[Authorize]</code> attribute to the
class or individual endpoints.</p>
<h2 id="developing-the-mobile-client">Developing the Mobile Client<a class="headerlink" href="#developing-the-mobile-client" title="Permanent link">&para;</a></h2>
<h2 id="handling-authorization-in-file-sync">Handling Authorization in File Sync<a class="headerlink" href="#handling-authorization-in-file-sync" title="Permanent link">&para;</a></h2>
<p>When we looked at the <a href="../../chapter3/projection/">data sync capabilities</a>, we used the concepts of filters and transforms to
ensure that a user could only see and change the data for which they had permissions.  Similar concepts
can be applied to the file sync capabilities as well.  There are three HTTP endpoints to concern
ourselves with:</p>
<ul>
<li>
<p>The <code>POST</code> endpoint (for obtaining a SAS token) should only produce an appropriate token based on
  the permissions structure.  If the user does not have the permissions for the requested file
  operations, a <strong>403 Forbidden</strong> response should be returned.</p>
</li>
<li>
<p>The <code>GET</code> endpoint (for obtaining a list of files) should only produce a list of files if the user
  is allowed to see the files.  If the user cannot see the associated database record, then a <strong>404 Not Found</strong>
  response should be returned.  If the user can see the records but is not allowed to view the files,
  an empty set should be returned.</p>
</li>
<li>
<p>The <code>DELETE</code> endpoint (for deleting a file) should only delete the file if the user is allowed to
  delete files.  If the user does not have permission to delete files, a <strong>403 Forbidden</strong> should be
  returned.</p>
</li>
</ul>
<p>We can use these rules to produce a constrained storage table controller.  For example, the following
code could be used for a table that did not allow file sync:</p>
<pre><code class="csharp">    [MobileAppController]
    public class TagStorageController : StorageController&lt;Tag&gt;
    {
        [HttpPost]
        [Route(&quot;tables/TodoItem/{id}/StorageToken&quot;)]
        public HttpResponseMessage StorageToken(string id, StorageTokenRequest value)
        {
            throw new HttpResponseException(HttpStatusCode.Forbidden);
        }

        [HttpGet]
        [Route(&quot;tables/TodoItem/{id}/MobileServiceFiles&quot;)]
        public HttpResponseMessage GetFiles(string id)
            =&gt; Request.CreateResponse(new List&lt;MobileServiceFile&gt;());

        [HttpDelete]
        [Route(&quot;tables/TodoItem/{id}/MobileServiceFiles/{name}&quot;)]
        public Task DeleteAsync(string id, string name)
        {
            throw new HttpResponseException(HttpStatusCode.Forbidden);
        }
    }
</code></pre>

<p>Since every single table controller needs an associated storage controller, you can use this pattern for the
storage controllers that should not support file sync.</p>
<!-- Images -->

<!-- Links -->
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../files/" title="Dealing with Files">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Dealing with Files
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../../push/" title="Push Notifications">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Push Notifications
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = 'adrianhall/develop-mobile-apps-with-csharp-and-azure';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
      <script src="../../js/highlight.pack.js"></script>
    
    
  </body>
</html>