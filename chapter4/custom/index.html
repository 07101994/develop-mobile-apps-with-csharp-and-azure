<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Custom HTTP Endpoints - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/custom/">
      
      
        <meta name="author" content="Adrian Hall">
      
    
    <meta property="og:url" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/custom/">
    <meta property="og:title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta property="og:image" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/custom//../../">
    <meta name="apple-mobile-web-app-title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-a422ff04cc.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Chapter 4 - Server Side Code <i class="icon icon-link"></i>
              
            
          </span>
        
        Custom HTTP Endpoints
      </div>
    </div>
    
      
      <div class="button button-twitter" role="button" aria-label="Twitter">
        <a href="https://twitter.com/FizzyInTheHall" title="@FizzyInTheHall on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
      </div>
    
    
      
      <div class="button button-github" role="button" aria-label="GitHub">
        <a href="https://github.com/adrianhall" title="@adrianhall on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
      </div>
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>
          Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          <span class="version">
            
          </span>
        </strong>
        
          <br>
          adrianhall/develop-mobile-apps-with-csharp-and-azure
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Getting Started" href="../..">
      Getting Started
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Chapter 1 - Introduction</span>
    <ul>
      
        
  <li>
    <a class="" title="Your First App - PC Edition" href="../../chapter1/firstapp_pc/">
      Your First App - PC Edition
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Your First App - Mac Edition" href="../../chapter1/firstapp_mac/">
      Your First App - Mac Edition
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 2 - Authentication</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter2/authconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Authentication in the Backend" href="../../chapter2/backend/">
      Authentication in the Backend
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Enterprise Authentication" href="../../chapter2/enterprise/">
      Enterprise Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Social Authentication" href="../../chapter2/social/">
      Social Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Debugging Authentication" href="../../chapter2/debugging/">
      Debugging Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Custom Authentication" href="../../chapter2/custom/">
      Custom Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Claims and Authorization" href="../../chapter2/authorization/">
      Claims and Authorization
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Tokens in Real Apps" href="../../chapter2/realworld/">
      Tokens in Real Apps
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Best Practices" href="../../chapter2/bestpractices/">
      Best Practices
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 3 - Data Access and Offline Sync</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter3/dataconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Implementing Table Controllers" href="../../chapter3/server/">
      Implementing Table Controllers
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Data Projection and Queries" href="../../chapter3/projection/">
      Data Projection and Queries
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Mobile Client" href="../../chapter3/client/">
      The Mobile Client
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Relationships" href="../../chapter3/relationships/">
      Relationships
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Domain Manager" href="../../chapter3/domainmgr/">
      The Domain Manager
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 4 - Server Side Code</span>
    <ul>
      
        
  <li>
    <a class="" title="Options for Server Code" href="../options/">
      Options for Server Code
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Custom HTTP Endpoints" href="./">
      Custom HTTP Endpoints
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Configuring Custom APIs" href="#configuring-custom-apis">
                Configuring Custom APIs
              </a>
            </li>
          
            <li class="anchor">
              <a title="Creating a Basic Custom API" href="#creating-a-basic-custom-api">
                Creating a Basic Custom API
              </a>
            </li>
          
            <li class="anchor">
              <a title="Handling Parameters to a Custom API" href="#handling-parameters-to-a-custom-api">
                Handling Parameters to a Custom API
              </a>
            </li>
          
            <li class="anchor">
              <a title="Handling POST Requests" href="#handling-post-requests">
                Handling POST Requests
              </a>
            </li>
          
            <li class="anchor">
              <a title="The Downside of Custom APIs" href="#the-downside-of-custom-apis">
                The Downside of Custom APIs
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
        
  <li>
    <a class="" title="WebJobs" href="../webjobs/">
      WebJobs
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Functions" href="../functions/">
      Functions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Recipes" href="../recipes/">
      Recipes
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 5 - Push Notifications</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter5/concepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Android Push" href="../../chapter5/android/">
      Android Push
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="iOS Push" href="../../chapter5/ios/">
      iOS Push
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Windows Push" href="../../chapter5/windows/">
      Windows Push
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Push Recipes" href="../../chapter5/recipes/">
      Push Recipes
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 6 - Combining Web and Mobile Apps</span>
    <ul>
      
        
  <li>
    <a class="" title="MVC Applications" href="../../chapter6/mvc/">
      MVC Applications
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="jQuery Applications" href="../../chapter6/jquery/">
      jQuery Applications
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Angular Applications" href="../../chapter6/angular/">
      Angular Applications
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="React Applications" href="../../chapter6/react/">
      React Applications
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 7 - Other Useful Services</span>
    <ul>
      
        
  <li>
    <a class="" title="Useful Azure Services" href="../../chapter7/services/">
      Useful Azure Services
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Azure Search" href="../../chapter7/search/">
      Azure Search
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Media Services" href="../../chapter7/media/">
      Media Services
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Real-time Notifications" href="../../chapter7/realtime/">
      Real-time Notifications
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 8 - Developing An App</span>
    <ul>
      
        
  <li>
    <a class="" title="The Development Environment" href="../../chapter8/developing/">
      The Development Environment
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Testing your Application" href="../../chapter8/testing/">
      Testing your Application
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 9 - Going to Production</span>
    <ul>
      
        
  <li>
    <a class="" title="Repeatable Deployments" href="../../chapter9/arm/">
      Repeatable Deployments
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Safe Deployments" href="../../chapter9/appsvc/">
      Safe Deployments
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Monitoring" href="../../chapter9/monitoring/">
      Monitoring
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Troubleshooting" href="../../chapter9/troubleshooting/">
      Troubleshooting
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Xamarin Forms Tips" href="../../xamarin_tips/">
      Xamarin Forms Tips
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Android Developer Notes" href="../../android_appendix/">
      Android Developer Notes
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Visual Studio Extensions" href="../../vs_extensions/">
      Visual Studio Extensions
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="References" href="../../references/">
      References
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Credits" href="../../credits/">
      Credits
    </a>
    
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
              
              <li>
                <a href="https://twitter.com/FizzyInTheHall" target="_blank" title="@FizzyInTheHall on Twitter">
                  @FizzyInTheHall on Twitter
                </a>
              </li>
            
            
              
              <li>
                <a href="https://github.com/adrianhall" target="_blank" title="@adrianhall on GitHub">
                  @adrianhall on GitHub
                </a>
              </li>
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="custom-http-endpoints">Custom HTTP Endpoints<a class="headerlink" href="#custom-http-endpoints" title="Permanent link">&para;</a></h1>
<p>Azure Mobile Apps makes it really easy to develop basic APIs that can be used in mobile clients.  Most
custom APIs can be simply invoked.  Azure Mobile Apps takes care of most of the scaffolding for you. The
server SDK will:</p>
<ul>
<li>Ensure the <code>ZUMO-API-VERSION</code> is present and valid.</li>
<li>Handle serialization and deserialization of JSON.</li>
<li>Ensure the API is given an appropriate URL.</li>
</ul>
<p>All the custom APIs will appear under the <code>/api</code> endpoint.  For example, if you created a controller
called <code>FooController</code>, it would be invoked by sending messages to <code>/api/Foo</code>.  This is case-insensitive,
so you could also reference this API as <code>/api/foo</code>.</p>
<h3 id="configuring-custom-apis">Configuring Custom APIs<a class="headerlink" href="#configuring-custom-apis" title="Permanent link">&para;</a></h3>
<p>Before anything happens, you must add the <code>MapApiControllers()</code> method to the <code>MobileAppConfiguration()</code>
call.  This is done in the <code>ConfigureMobileApp()</code> method in <code>App_Start\Startup.MobileApp.cs</code> file:</p>
<pre><code class="csharp">    new MobileAppConfiguration()
        .AddTablesWithEntityFramework()     /* /tables endpoints */
        .MapApiControllers()                /* /api endpoints */
        .ApplyTo(config);
</code></pre>

<p>The <code>MapApiControllers()</code> extension method does the actual work of looking for custom APIs and mapping them
onto the <code>/api</code> endpoint.</p>
<h3 id="creating-a-basic-custom-api">Creating a Basic Custom API<a class="headerlink" href="#creating-a-basic-custom-api" title="Permanent link">&para;</a></h3>
<p>You might remember that the original Azure Mobile Apps project within Visual Studio comes with a sample
custom API called the <code>ValuesController</code>.  This controller did not do anything useful.  Let's re-create
it from scratch.</p>
<ul>
<li>Right-click the <code>Controllers</code> node in your backend project and use <strong>Add</strong> -&gt; <strong>Controller...</strong>.</li>
</ul>
<p><img alt="" src="../img/add-custom-controller-1.PNG" /></p>
<ul>
<li>Select the <strong>Azure Mobile Apps Custom Controller</strong>, then click <strong>Add</strong>.</li>
<li>Enter the name for the controller, for example, <strong>ValuesController</strong>.  Click <strong>Add</strong>.</li>
</ul>
<p>The new controller will be scaffolded for you.  When you are done, it looks like this:</p>
<pre><code class="csharp">using System.Web.Http;
using Microsoft.Azure.Mobile.Server.Config;

namespace Backend.Controllers
{
    [MobileAppController]
    public class ValuesController : ApiController
    {
        // GET api/Default
        public string Get()
        {
            return &quot;Hello from custom controller!&quot;;
        }
    }
}
</code></pre>

<p>If you have not done anything that requires a backend, then you can press F5 to run the backend and use
Postman to interact with your new custom API:</p>
<p><img alt="" src="../img/add-custom-controller-2.PNG" /></p>
<p>We still have to submit the <code>ZUMO-API-VERSION</code> header for this to work.  Whatever my method returns will
be returned as JSON.  This one is not exactly exciting.  One of the things I do quite often is provide
a configuration endpoint called <code>/api/config</code> which returns a JSON object that I can use to configure the
mobile client.</p>
<pre><code class="csharp">using System.Web.Http;
using Microsoft.Azure.Mobile.Server.Config;
using System.Collections.Generic;
using System;

namespace Backend.Controllers
{
    [MobileAppController]
    public class ConfigController : ApiController
    {
        private ConfigViewModel configuration;

        public ConfigController()
        {
            Dictionary&lt;string, ProviderInformation&gt; providers = new Dictionary&lt;string, ProviderInformation&gt;();

            AddToProviders(providers, &quot;aad&quot;, &quot;MOBILE_AAD_CLIENT_ID&quot;);
            AddToProviders(providers, &quot;facebook&quot;, &quot;MOBILE_FB_CLIENT_ID&quot;);
            AddToProviders(providers, &quot;google&quot;, &quot;MOBILE_GOOGLE_CLIENT_ID&quot;);
            AddToProviders(providers, &quot;microsoftaccount&quot;, &quot;MOBILE_MSA_CLIENT_ID&quot;);
            AddToProviders(providers, &quot;twitter&quot;, &quot;MOBILE_TWITTER_CLIENT_ID&quot;);

            configuration = new ConfigViewModel
            {
                AuthProviders = providers
            };
        }

        private void AddToProviders(Dictionary&lt;string, ProviderInformation&gt; providers, string provider, string envVar)
        {
            string envVal = Environment.GetEnvironmentVariable(envVar);
            if (envVal != null &amp;&amp; envVal?.Length &gt; 0)
            {
                providers.Add(provider, new ProviderInformation { ClientId = envVal });
            }

        }

        [HttpGet]
        public ConfigViewModel Get()
        {
            return configuration;
        }
    }

    public class ProviderInformation
    {
        public string ClientId { get; set; }
    }

    public class ConfigViewModel
    {
        public Dictionary&lt;string, ProviderInformation&gt; AuthProviders { get; set; }
    }
}
</code></pre>

<p>The constructor produces a <code>ConfigViewModel</code> for me.  This describes the configuration object I want to send.  In
this case, I want to send the client ID for each authentication provider.  If the authentication provider is not
configured, then the client ID is not sent.  I use the application settings to determine what is configured. The
primary idea behind this is to integrate all the client flows within my mobile client.  When the user wishes to
log in, they are presented with a menu of options and can pick which social provider they wish to use.  The
client-flow authentication libraries may use different client IDs than the ones that are configured into the authentication
service.  For example, AAD uses two client IDs - one for server-flow and one for client-flow.  As a result, this
controller uses <strong>Application Settings</strong> (which appear as environment variables to the backend) to set the
client IDs.  The result of calling this API from Postman looks like this:</p>
<p><img alt="" src="../img/add-custom-controller-3.PNG" /></p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>Only expose information that you would normally and reasonably embed in a mobile client.  Never transmit
secrets this way.  It is insecure and can put your entire authentication system at risk of hijack.</p>
</div>
<p>You can read this information using the Azure Mobile Apps Client SDK once you have a client reference, using
the same model classes:</p>
<pre><code class="csharp">var configuration = await client.InvokeAsync&lt;ConfigViewModel&gt;(&quot;config&quot;, HttpMethod.Get, null);
</code></pre>

<p>You must specify a class that deserializes the JSON that is produced by your API.  If you use the same classes,
that is practically guaranteed.  The other methods in call are the HTTP Method (GET, POST, PATCH, DELETE, etc.)
and the query parameters.</p>
<h3 id="handling-parameters-to-a-custom-api">Handling Parameters to a Custom API<a class="headerlink" href="#handling-parameters-to-a-custom-api" title="Permanent link">&para;</a></h3>
<p>The <code>/api/config</code> endpoint didn't require any information that is extra.  Sometimes, we need to provide
extra information so that the right thing can be produced.  For example, consider the case of uploading
or downloading a file to Azure Storage.  We may want to provide some extra information - the filename of
the file we want to upload and the permissions for the file.  Uploading and downloading files is discussed
more fully <a href="../recipes/">later</a> in the book and offers a fuller example of this concept.</p>
<p>To illustrate the concept clearly, let's create an API that adds two numbers together.  We would call
this API through HTTP like this: <code>GET /api/addition?first=1&amp;second=2</code>.  The first number gets added to
the second number and we will return the result.  If the first or the second number doesn't exist, we
want to produce a 400 Bad Request response rather than crashing the server.  Here is the code:</p>
<pre><code class="csharp">using System.Web.Http;
using Microsoft.Azure.Mobile.Server.Config;
using System.Net;

namespace Backend.Controllers
{
    [MobileAppController]
    public class AdditionController : ApiController
    {
        // GET api/Addition
        public ResultViewModel Get(int? first, int? second)
        {
            if (first == null || second == null)
            {
                throw new HttpResponseException(HttpStatusCode.BadRequest);
            }
            ResultViewModel results = new ResultViewModel
            {
                First = first.GetValueOrDefault(),
                Second = second.GetValueOrDefault()
            };
            results.Result = results.First + results.Second;
            return results;
        }
    }

    public class ResultViewModel
    {
        public int First { get; set; }
        public int Second { get; set; }
        public int Result { get; set; }
    }
}
</code></pre>

<p>If you try this out, you will notice something rather odd.  Try doing the following URL: <code>/api/addition?first=1&amp;second=2</code>.
You will note it works as expected.  However, if you try doing the following URL: <code>/api/addition?first=1</code>, then you
will note that you get a <strong>404 Not Found</strong>.  This makes the API easy to write because you don't have to worry about
your code receiving bad input (most of the time).  However, you may not get the API surface that you want.  In this
case, I want to return a <strong>400 Bad Request</strong> instead of the normal 404 response.  I have to do a lot more work to
support this case:</p>
<pre><code class="csharp">    public class AdditionController : ApiController
    {
        // GET api/Addition
        public ResultViewModel Get()
        {
            int? first = GetParameter(Request, &quot;first&quot;),
                 second = GetParameter(Request, &quot;second&quot;);

            ResultViewModel results = new ResultViewModel
            {
                First = first.GetValueOrDefault(),
                Second = second.GetValueOrDefault()
            };
            results.Result = results.First + results.Second;
            return results;
        }

        private int? GetParameter(HttpRequestMessage request, string name)
        {
            var queryParams = request.GetQueryNameValuePairs().Where(kv =&gt; kv.Key == name).ToList();
            if (queryParams.Count == 0)
            {
                throw new HttpResponseException(HttpStatusCode.BadRequest);
            }

            int rv;
            if (!Int32.TryParse(queryParams[0].Value, out rv))
            {
                throw new HttpResponseException(HttpStatusCode.BadRequest);
            }
            return rv;
        }
    }
</code></pre>

<p>When our Get() routine does not take parameters, no particular pattern is required.  We can use the <code>Request</code>
object to access the parameters we send.  In this case, the <code>GetParameter()</code> routine checks to see if there
is a named parameter and converts it to an integer.  If the named parameter is not there or it is not numeric,
then a Bad Request response is sent.</p>
<h3 id="handling-post-requests">Handling POST Requests<a class="headerlink" href="#handling-post-requests" title="Permanent link">&para;</a></h3>
<p>GET and DELETE requests take parameters on the URI.  These cam ne dealt with via the automatic conversion to
method parameters or they can be handled via LINQ queries on the request object, as we observed in the prior
section.  POST requests, by contrast, allow you to submit a JSON body for processing.  This is useful when we
want to submit multiple JSON objects for processing.  For example, one of the common requirements we have is
for transactions.  When we want to submit two objects that are joined by a foreign key, we can submit them
both and construct a transaction in the backend with Entity Framework.</p>
<p>Let's take an example.  We want to produce a music trakcing mobile app.  When we add an album to our music
database, we also want to add the tracks for that database.  This can be modeled with code first Entity
Framework:</p>
<pre><code class="csharp">public class Track : EntityData
{
    public Track() {}

    public string Title { get; set; }
    public int Length { get; set; }

    public virtual Album Album { get; set; }
}

public class Album : EntityData
{
    public Album()
    {
        Tracks = new List&lt;Track&gt;();
    }

    public string Title { get; set; }

    public virtual ICollection&lt;Track&gt; Tracks { get; set; }
}
</code></pre>

<p>This will generate a foreign key relationship in the tables of our database.  However, as we learned in
<a href="../../chapter3/relationships/">chapter 3</a>, relationships are hard to implement and come with some serious caveats.  We could decouple
the tracks from the albums, but let's instead try to insert the data for an album all in one go.  We do
this by submitting the JSON for an Album to a custom controller:</p>
<pre><code class="csharp">    [MobileAppController]
    public class AlbumCustomController : ApiController
    {
        MobileServiceContext context;

        public AlbumCustomController() : base()
        {
            context = new MobileServiceContext();
        }

        [HttpPost]
        public async Task&lt;AlbumCustomResponse&gt; PostAsync([FromBody] Album newAlbum)
        {
            // Use a transaction to update the database
            using (DbContextTransaction transaction = context.Database.BeginTransaction())
            {
                try
                {
                    context.Albums.Add(newAlbum);
                    await context.SaveChangesAsync();
                    transaction.Commit();
                }
                catch (Exception ex)
                {
                    transaction.Rollback();
                }
            }

            // Now generate whatever output we want.
            AlbumCustomResponse response = new AlbumCustomResponse
            {
                Status = 200
            };
            return response;
        }
    }
</code></pre>

<p>In this particular scenario, we would construct an album object on the mobile client side that directly corresponded
to the JSON we want to push to the database, including the track information.  Let's take a look at a typical call:</p>
<pre><code class="csharp">var response = client.InvokeApiAsync&lt;Album,AlbumCustomResponse&gt;(
    &quot;AlbumController&quot;,              // The name of the API
    newAlbum,                       // The body of the POST
    HttpMethod.Post,                // The HTTP Method
    null,                           // Request Headers
    null);                          // Parameters
</code></pre>

<p>There are <a href="https://github.com/Azure/azure-mobile-apps-net-client/blob/bfe421987a9fabcf82f341355749c64a1eed43c3/src/Microsoft.WindowsAzure.MobileServices/IMobileServiceClient.cs#L186">quite a few signatures</a> for the <code>InvokeApiAsync&lt;&gt;()</code> method.  This one sends an <code>Album</code> object as JSON as the
body of the request, and returns an <code>AlbumCustomResponse</code>, decoding the response as it goes.</p>
<h2 id="the-downside-of-custom-apis">The Downside of Custom APIs<a class="headerlink" href="#the-downside-of-custom-apis" title="Permanent link">&para;</a></h2>
<p>Given that we can do transaction processing within a custom API, one might be forgiven for wondering why we don't
use custom APIs for processing data within our normalized SQL schema.  The problem, of course, is that custom APIs
(including WebAPIs) can only be executed while connected to the Internet.  When the mobile device is offline, the
custom API cannot be executed, thus breaking our offline model.  Offline just doesn't mix with SQL relationships.</p>
<p>When I first encountered this, I thought a great idea may be to instantiate a queue, much like the Operations Queue
that is used within the offline sync process.  When I want to queue up a transaction, I insert it into my own
operations queue.  My early research used a light-weight queuing mechanism (<a href="http://www.codeproject.com/Articles/193611/DotNetMQ-A-Complete-Message-Queue-System-for-NET">DotNetMQ</a>, for those interested) to
implement the queue.  Transactions were inserted into the queue at the appropriate time in the client.  During the
sync process, the transactions were pushed, then the tables were pulled.  The problem is that the tables in the
offline sync were not maintained until a pull, resulting in "old data".  If I updated the data in the offline cache
as well, I produced many conflicts and inconsistent data within the offline cache.  In the end, I concluded that
it was better to loosely couple the tables that were being used (as we discussed in <a href="../../chapter3/relationships/">chapter 3</a>).</p>
<!-- Images -->

<!-- URLs -->
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../options/" title="Options for Server Code">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Options for Server Code
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../webjobs/" title="WebJobs">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                WebJobs
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = 'adrianhall/develop-mobile-apps-with-csharp-and-azure';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
      <script src="../../js/highlight.pack.js"></script>
    
    
  </body>
</html>