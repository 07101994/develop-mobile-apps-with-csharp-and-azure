<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Dealing with Files - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/files/">
      
      
        <meta name="author" content="Adrian Hall">
      
    
    <meta property="og:url" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/files/">
    <meta property="og:title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta property="og:image" content="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter4/files//../../">
    <meta name="apple-mobile-web-app-title" content="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-a422ff04cc.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Chapter 4 - File Management <i class="icon icon-link"></i>
              
            
          </span>
        
        Dealing with Files
      </div>
    </div>
    
      
      <div class="button button-twitter" role="button" aria-label="Twitter">
        <a href="https://twitter.com/FizzyInTheHall" title="@FizzyInTheHall on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
      </div>
    
    
      
      <div class="button button-github" role="button" aria-label="GitHub">
        <a href="https://github.com/adrianhall" title="@adrianhall on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
      </div>
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>
          Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          <span class="version">
            
          </span>
        </strong>
        
          <br>
          adrianhall/develop-mobile-apps-with-csharp-and-azure
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Getting Started" href="../..">
      Getting Started
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Chapter 1 - Introduction</span>
    <ul>
      
        
  <li>
    <a class="" title="Your First App - PC Edition" href="../../chapter1/firstapp_pc/">
      Your First App - PC Edition
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Your First App - Mac Edition" href="../../chapter1/firstapp_mac/">
      Your First App - Mac Edition
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 2 - Authentication</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter2/authconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Authentication in the Backend" href="../../chapter2/backend/">
      Authentication in the Backend
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Enterprise Authentication" href="../../chapter2/enterprise/">
      Enterprise Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Social Authentication" href="../../chapter2/social/">
      Social Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Debugging Authentication" href="../../chapter2/debugging/">
      Debugging Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Custom Authentication" href="../../chapter2/custom/">
      Custom Authentication
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Claims and Authorization" href="../../chapter2/authorization/">
      Claims and Authorization
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Tokens in Real Apps" href="../../chapter2/realworld/">
      Tokens in Real Apps
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Best Practices" href="../../chapter2/bestpractices/">
      Best Practices
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 3 - Data Access and Offline Sync</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../../chapter3/dataconcepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Implementing Table Controllers" href="../../chapter3/server/">
      Implementing Table Controllers
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Data Projection and Queries" href="../../chapter3/projection/">
      Data Projection and Queries
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Mobile Client" href="../../chapter3/client/">
      The Mobile Client
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Relationships" href="../../chapter3/relationships/">
      Relationships
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="The Domain Manager" href="../../chapter3/domainmgr/">
      The Domain Manager
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Chapter 4 - File Management</span>
    <ul>
      
        
  <li>
    <a class="" title="Concepts" href="../concepts/">
      Concepts
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Dealing with Files" href="./">
      Dealing with Files
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Uploading a File to Blob Storage" href="#uploading-a-file-to-blob-storage">
                Uploading a File to Blob Storage
              </a>
            </li>
          
            <li class="anchor">
              <a title="Download a File from Blob Storage" href="#download-a-file-from-blob-storage">
                Download a File from Blob Storage
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
        
  <li>
    <a class="" title="File Synchronization" href="../filesync/">
      File Synchronization
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Push Notifications" href="../../push/">
      Push Notifications
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Server Side Code" href="../../custom/">
      Server Side Code
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Media Services" href="../../media/">
      Media Services
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Leveraging Search" href="../../search/">
      Leveraging Search
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Web and Mobile Apps" href="../../combined/">
      Web and Mobile Apps
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="The Development Environment" href="../../developing/">
      The Development Environment
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Testing your Application" href="../../testing/">
      Testing your Application
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Troubleshooting" href="../../troubleshooting/">
      Troubleshooting
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Going to Production" href="../../production/">
      Going to Production
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Xamarin Forms Tips" href="../../xamarin_tips/">
      Xamarin Forms Tips
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Android Developer Notes" href="../../android_appendix/">
      Android Developer Notes
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="References" href="../../references/">
      References
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Credits" href="../../credits/">
      Credits
    </a>
    
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
              
              <li>
                <a href="https://twitter.com/FizzyInTheHall" target="_blank" title="@FizzyInTheHall on Twitter">
                  @FizzyInTheHall on Twitter
                </a>
              </li>
            
            
              
              <li>
                <a href="https://github.com/adrianhall" target="_blank" title="@adrianhall on GitHub">
                  @adrianhall on GitHub
                </a>
              </li>
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="dealing-with-files">Dealing with Files<a class="headerlink" href="#dealing-with-files" title="Permanent link">&para;</a></h1>
<p>The most normal tasks for dealing with files are the upload and download of files to blob storage.  There is
a natural and consistent process to this which makes this recipe very repeatable.  First, deal with the things
you need before you start:</p>
<ol>
<li>Create an Azure Storage Account and link it to your Azure App Service.</li>
<li>Decide how you want your files organized.</li>
<li>Create a WebAPI to generate a SAS token for your upload or download.</li>
</ol>
<p>I've already discussed <a href="../concepts/#create-storage-account">how to create and link an Azure Storage Account</a>.  Blob storage is organized in a
typical directory structure.  Each directory is called a container, and each file is a blob.  In the examples
for this section, I am going to store each uploaded file in a container based on the authenticated user.  My
WebAPI will create the appropriate container and then return an appropriate SAS token.</p>
<p>We haven't discussed custom code yet.  We will go much deeper than we do right now.  Custom APIs allow us to
write custom code and execute it within the context of the mobile backend.  It has access to many of the same
facilities as the rest of the mobile backend - things like app settings, connection strings, and the Entity
Framework structure.  To enable custom APIs, you need to alter the <code>App_Start\Startup.MobileApp.cs</code> file so
that the custom APIs are attached to HTTP routes properly:</p>
<pre><code class="csharp">    HttpConfiguration config = new HttpConfiguration();

    new MobileAppConfiguration()
        .AddTablesWithEntityFramework()
        .MapApiControllers()
        .ApplyTo(config);
</code></pre>

<p>The Custom API is a standard ASP.NET controller with the <code>[MobileAppController]</code> attribute attached to the
class.  The <code>[MobileAppController]</code> signals to Azure Mobile Apps that the controller needs to be registered
under the <code>/api</code> endpoint.  It also handles API version checking (or at least checks that the <code>ZUMO-API-VERSION</code>
header is set to 2.0.0) and appropriately handles authorization if the <code>[Authorize]</code> attribute is present. The
mapping under the <code>/api</code> endpoint only happens if the <code>.MapApiControllers()</code> extension method is called during
configuration.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Ensure you install the latest version of the <code>WindowsAzure.Storage</code> Nuget package using the NuGet package
Manager before continuing.</p>
</div>
<p>When we linked the Azure Storage account, we added a connection string called <code>MS_AzureStorageAccountConnectionString</code>.
This is included in the environment as <code>CUSTOMCONNSTR_MS_AzureStorageAccountConnectionString</code>.  We can add a new
Custom API controller in Visual Studio by right-clicking on the <strong>Controllers</strong> node, then selecting <strong>Add</strong> -&gt;
<strong>Controller...</strong> and selecting the <strong>Azure Mobile APps Custom Controller</strong> option.  We can set up our custom API
as follows:</p>
<pre><code class="csharp">namespace Backend.Controllers
{
    [Authorize]
    [MobileappController]
    public class GetStorageTokenController : ApiController
    {
        private const string connString = &quot;CUSTOMCONNSTR_MS_AzureStorageAccountConnectionString&quot;;

        public GetStorageTokenController()
        {
            ConnectionString = Environment.GetEnvironmentVariable(connString);
            StorageAccount = CloudStorageAccount.Parse(ConnectionString);
            BlobClient = StorageAccount.CreateCloudBlobClient();
        }

        public string ConnectionString { get; }

        public CloudStorageAccount StorageAccount { get; }

        public CloudBlobClient BlobClient { get; }
    }
}
</code></pre>

<p>The <code>ConnectionString</code> property is the pointer to where the Azure Storage account is located and how to
access it.  the <code>StorageAccount</code> is a reference to that Azure Storage account.  Finally, the <code>BlobClient</code>
is an object used for accessing blob storage.  We can access any WebAPI methods in this class by using
the endpoint <code>/api/GetStorageToken</code> within our mobile client or using Postman.</p>
<p>Azure Storage doesn't have a true heirarchial container system.  It does have containers and directories
to organize things though, so we are going to use that:</p>
<pre><code class="csharp">    private const string containerName = &quot;userdata&quot;;

    [HttpGet]
    public async Task&lt;StorageTokenViewModel&gt; GetAsync()
    {
        // The userId is the SID without the sid: prefix
        var claimsPrincipal = User as ClaimsPrincipal;
        var userId = claimsPrincipal
            .FindFirst(ClaimTypes.NameIdentifier)
            .Value.Substring(4);

        // Errors creating the storage container result in a 500 Internal Server Error
        var container = BlobClient.GetContainerReference(containerName);
        await container.CreateIfNotExistsAsync();

        // Get the user directory within the container
        var directory = container.GetDirectoryReference(userId);
        var blobName = Guid.NewGuid().ToString(&quot;N&quot;);
        var blob = directory.GetBlockBlobReference(blobName);

        // Create a policy for accessing the defined blob
        var blobPolicy = new SharedAccessBlobPolicy
        {
            SharedAccessStartTime = DateTime.UtcNow.AddMinutes(-5),
            SharedAccessExpiryTime = DateTime.UtcNow.AddMinutes(60),
            Permissions = SharedAccessBlobPermissions.Read
                        | SharedAccessBlobPermissions.Write
                        | SharedAccessBlobPermissions.Create
        };

        return new StorageTokenViewModel
        {
            Name = blobName,
            Uri = blob.Uri,
            SasToken = blob.GetSharedAccessSignature(blobPolicy)
        };
    }
</code></pre>

<p>The main piece of work in this API is generating the policy that is then signed and returned to
the user as the SAS Token.  The mobile device has permission to read, write and create the blob
that we have defined for the next 60 minutes.  I've provided a policy that starts in the past in
case there is a little amount of clock-skew between the mobile device and the backend.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>Container names must be a valid DNS name.  The most notable requirement here is between 3
and 64 lower-case letters.  Container names are case-sensitive.  Check <a href="https://msdn.microsoft.com/library/azure/dd135715.aspx">the documentation</a>
for full details on naming requirements.</p>
</div>
<p>The <code>StorageTokenViewModel</code> is used for serialization purposes:</p>
<pre><code class="csharp">public class StorageTokenViewModel
{
    public string Name { get; set; }
    public Uri Uri { get; set; }
    public string SasToken { get; set; }
}
</code></pre>

<p>We can test this API using Postman.  First, generate an authentication token.  Then use Postman to
do a GET of the <code>/api/GetStorageToken</code> endpoint:</p>
<p><img alt="" src="../img/getstoragetoken-1.PNG" /></p>
<p>There are two pieces of information we need here.  Firstly, the <code>uri</code> property provides the URI that we are going to
use to upload the file.  Secondly, the <code>sasToken</code> is appended to the <code>uri</code> when uploading to provide a link to the
policy.  Note that the token start and expiry time are encoded and readable in the sasToken.</p>
<p>In real world applications, this is likely not the right method.  We might want to organize the files based on information
that the mobile client provides us, for example.  We may also want to upload to a specific upload area and then download
from another location, allowing processing of the files in between.  You may also want to append the uploaded file extension
to the file before uploading.  There is no "one size fits all" token policy.  You must decide on the conditions under which
you will allow upload and download capabilities and then provide the appropriate logic to generate the SAS token.</p>
<h2 id="uploading-a-file-to-blob-storage">Uploading a File to Blob Storage<a class="headerlink" href="#uploading-a-file-to-blob-storage" title="Permanent link">&para;</a></h2>
<p>Once we have the logic to generate a SAS token, we can turn our attention to the mobile clients.  We need to do three
things for uploading a file to the service:</p>
<ol>
<li>Get a reference to the file (as a Stream object).</li>
<li>Generate a SAS token using the custom API.</li>
<li>Use the Azure Storage SDK to upload directly to the Azure Storage Account.</li>
</ol>
<p>You should not upload to a custom API in your mobile backend.  This needlessly ties up your mobile backend, causing your
mobile backend to be less efficient at scaling.  Your mobile backend will likely not have all the facilities that the
Azure Storage endpoint has provided either.  Azure Storage provides upload and download restarts and progress bar
capabilities.</p>
<p>Obtaining a reference to the file that you wish to upload is inevitably a per-platform API.  To support this, we need to
add an interface for the API to the <code>Abstractions\IPlatform.cs</code> file:</p>
<pre><code class="csharp">Task&lt;String&gt; GetUploadFile();
</code></pre>

<h2 id="download-a-file-from-blob-storage">Download a File from Blob Storage<a class="headerlink" href="#download-a-file-from-blob-storage" title="Permanent link">&para;</a></h2>
<!-- Images -->

<!-- Links -->
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../concepts/" title="Concepts">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Concepts
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../filesync/" title="File Synchronization">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                File Synchronization
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = 'adrianhall/develop-mobile-apps-with-csharp-and-azure';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
      <script src="../../js/highlight.pack.js"></script>
    
    
  </body>
</html>