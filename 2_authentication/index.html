<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>2. Authentication - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../extra.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "2. Authentication";
    var mkdocs_page_input_path = "2_authentication.md";
    var mkdocs_page_url = "/2_authentication/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Introduction</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../1_introduction/">1. Your First Mobile App</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">2. Authentication</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#authentication">Authentication</a></li>
                
                    <li><a class="toctree-l4" href="#authentication-concepts">Authentication Concepts</a></li>
                
                    <li><a class="toctree-l4" href="#adding-authentication-to-a-mobile-backend">Adding Authentication to a Mobile Backend</a></li>
                
                    <li><a class="toctree-l4" href="#implementing-authentication-to-a-mobile-client">Implementing Authentication to a Mobile Client</a></li>
                
                    <li><a class="toctree-l4" href="#custom-authentication">Custom Authentication</a></li>
                
                    <li><a class="toctree-l4" href="#authorization">Authorization</a></li>
                
                    <li><a class="toctree-l4" href="#refresh-tokens">Refresh Tokens</a></li>
                
                    <li><a class="toctree-l4" href="#logging-out">Logging out</a></li>
                
                    <li><a class="toctree-l4" href="#best-practices">Best Practices</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../3_data/">3. Data Access and Offline Sync</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../4_authdata/">4. Authenticated Data Access</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../5_files/">5. File Management</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../6_push/">6. Push Notifications</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../7_custom/">7. Server Side Code</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../8_media/">8. Media Services</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../9_search/">9. Leveraging Search</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../10_combined/">10. Web and Mobile Apps</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../11_developing/">11. The Development Environment</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../12_testing/">12. Testing your Application</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../13_troubleshooting/">13. Troubleshooting</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../14_production/">14. Going to Production</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../references/">References</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>2. Authentication</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="authentication">Authentication</h1>
<p>One of the very first things you will want to do is to provide users with a
unique experience.  For our example task list application, this could be as
simple as providing a task list for the user who is logged in.  In more complex
applications, this is the gateway to role-based access controls, group rules,
and sharing with your friends.  In all these cases, properly identifying the
user using the phone is the starting point.</p>
<h2 id="authentication-concepts">Authentication Concepts</h2>
<p>Authentication provides a process by which the user that is using the mobile
device can be identified securely.  This is generally done by entering a username
and password.  However, modern systems can also provide <a href="https://en.wikipedia.org/wiki/Multi-factor_authentication">multi-factor authentication</a>,
send you a text message to a registered device, or <a href="https://support.apple.com/en-us/HT201371">use your fingerprint</a> as the password.</p>
<h3 id="the-oauth-process">The OAuth Process</h3>
<p>In just about every single mobile application, a process called <a href="http://oauth.net/2/">OAuth</a> is used
to properly identify a user to the mobile backend.  OAuth is not an authentication
mechanism in its own right.  It is used to route the authentication request to the
right place and to verify that the authentication took place. There are three actors
in the OAuth protocol:</p>
<ul>
<li>The <strong>Client</strong> is the application attempting to get access to the resource.</li>
<li>The <strong>Resource</strong> is the mobile backend that the client is attempting to access.</li>
<li>The <strong>Identity Provider</strong> (or IdP) is the service that is responsible for authenticating the client.</li>
</ul>
<p>At the end of the process, a cryptographically signed token is minted.  This
token is added to every single subsequent request to identify the user.</p>
<h3 id="server-side-vs-client-side-authentication">Server Side vs. Client Side Authentication</h3>
<p>There are two types of authentication flow: Server-Flow and Client-Flow.  They
are so named because of who controls the flow of the actual authentication.  In
a server-flow authentication, the client asks Azure Mobile Apps to login.  Azure
Mobile Apps then redirects to the configured Identity Provider.  That IdP will
then authenticate the user before redirecting back to Azure Mobile Apps.  At
this point, Azure Mobile Apps will mint a ZUMO token that shows the user is
authenticated and return that token to the client application.  </p>
<p><img alt="Server-Flow" src="../img/ch2/idp-flow.PNG" /></p>
<p>Server-flow is named because the authentication flow is managed by the server
through a web connection.  It is generally used in two cases:</p>
<ul>
<li>You want a simple placeholder for authentication in your mobile app while you are developing other code.</li>
<li>You are developing a web app.</li>
</ul>
<p>Client-flow authentication uses an IdP provided SDK to integrate a more native
feel to the authentication flow.  The actual flow happens on the client,
communicating only with the IdP.  For example, if you use the Facebook SDK for
authentication, your app will seamlessly switch over into the Facebook app and
ask you to authorize your client application before switching you back to your
client application.  The IdP SDK will return a token to your code.  Your client
application will then contact the mobile backend to swap the IdP token for a
ZUMO token.  You will then use the ZUMO token to communicate with the mobile
backend.</p>
<p>It is generally recommended that you use the IdP SDK when developing an app
that will be released on the app store.  This follows the best practice provided
by the majority of identity providers and provides the best experience for your
end users.</p>
<h3 id="authentication-providers">Authentication Providers</h3>
<p>Azure Mobile Apps supports five identity providers natively:</p>
<ul>
<li>Azure Active Directory</li>
<li>Facebook</li>
<li>Google</li>
<li>Microsoft (MSA)</li>
<li>Twitter</li>
</ul>
<p>In addition, you can set up client-flow custom authentication that allows
you to mint a ZUMO token to your specifications for any provider using a
client-flow.  For example, you could use authentication providers like
<a href="https://azure.microsoft.com/en-us/services/active-directory-b2c/">Azure AD B2C</a>, <a href="https://developer.linkedin.com/docs/oauth2">LinkedIn</a> or <a href="https://developer.github.com/v3/oauth/">GitHub</a>, a third-party authentication
provider like  <a href="https://auth0.com/">Auth0</a>, or you could set up an identity table in your
database so that you can check  username and password without an identity
provider.</p>
<h2 id="adding-authentication-to-a-mobile-backend">Adding Authentication to a Mobile Backend</h2>
<p>Adding authentication to an Azure Mobile Apps backend is made easier because
Azure Mobile Apps adds authentication using the default ASP.NET identity
framework.  However, you must add the authentication initialization code to
your <code>Startup.MobileApp.cs</code> file:</p>
<pre><code class="csharp">public static void ConfigureMobileApp(IAppBuilder app)
{
    HttpConfiguration config = new HttpConfiguration();

    new MobileAppConfiguration()
        .AddTablesWithEntityFramework()
        .ApplyTo(config);

    // Use Entity Framework Code First to create database tables based on your DbContext
    Database.SetInitializer(new MobileServiceInitializer());

    MobileAppSettingsDictionary settings = config.GetMobileAppSettingsProvider().GetMobileAppSettings();

    if (string.IsNullOrEmpty(settings.HostName))
    {
        app.UseAppServiceAuthentication(new AppServiceAuthenticationOptions
        {
            // This middleware is intended to be used locally for debugging. By default, HostName will
            // only have a value when running in an App Service application.
            SigningKey = ConfigurationManager.AppSettings[&quot;SigningKey&quot;],
            ValidAudiences = new[] { ConfigurationManager.AppSettings[&quot;ValidAudience&quot;] },
            ValidIssuers = new[] { ConfigurationManager.AppSettings[&quot;ValidIssuer&quot;] },
            TokenHandler = config.GetAppServiceTokenHandler()
        });
    }

    app.UseWebApi(config);
}
</code></pre>

<p>Authentication is done at one of two levels.  We can add
authentication to an entire table controller by adding the <code>[Authorize]</code>
attribute to the table controller.  We can also add authentication on
individual operations by adding the <code>[Authorize]</code> attribute to individual
methods within the table controller. For example, here is our table controller
from the first chapter with authentication required for all operations:</p>
<pre><code class="csharp">using System.Linq;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.OData;
using Backend.DataObjects;
using Backend.Models;
using Microsoft.Azure.Mobile.Server;

namespace Backend.Controllers
{
    [Authorize]
    public class TodoItemController : TableController&lt;TodoItem&gt;
    {
        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            MobileServiceContext context = new MobileServiceContext();
            DomainManager = new EntityDomainManager&lt;TodoItem&gt;(context, Request);
        }

        // GET tables/TodoItem
        public IQueryable&lt;TodoItem&gt; GetAllTodoItems() =&gt; Query();

        // GET tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public SingleResult&lt;TodoItem&gt; GetTodoItem(string id) =&gt; Lookup(id);

        // PATCH tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public Task&lt;TodoItem&gt; PatchTodoItem(string id, Delta&lt;TodoItem&gt; patch) =&gt; UpdateAsync(id, patch);

        // POST tables/TodoItem
        public async Task&lt;IHttpActionResult&gt; PostTodoItem(TodoItem item)
        {
            TodoItem current = await InsertAsync(item);
            return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
        }

        // DELETE tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public Task DeleteTodoItem(string id) =&gt; DeleteAsync(id);
    }
}
</code></pre>

<p>We could also have a version where reading was possible anonymously but
updating the database required authentication:</p>
<pre><code class="csharp">using System.Linq;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.OData;
using Backend.DataObjects;
using Backend.Models;
using Microsoft.Azure.Mobile.Server;

namespace Backend.Controllers
{
    public class TodoItemController : TableController&lt;TodoItem&gt;
    {
        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            MobileServiceContext context = new MobileServiceContext();
            DomainManager = new EntityDomainManager&lt;TodoItem&gt;(context, Request);
        }

        // GET tables/TodoItem
        public IQueryable&lt;TodoItem&gt; GetAllTodoItems() =&gt; Query();

        // GET tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public SingleResult&lt;TodoItem&gt; GetTodoItem(string id) =&gt; Lookup(id);

        // PATCH tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        [Authorize]
        public Task&lt;TodoItem&gt; PatchTodoItem(string id, Delta&lt;TodoItem&gt; patch) =&gt; UpdateAsync(id, patch);

        // POST tables/TodoItem
        [Authorize]
        public async Task&lt;IHttpActionResult&gt; PostTodoItem(TodoItem item)
        {
            TodoItem current = await InsertAsync(item);
            return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
        }

        // DELETE tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        [Authorize]
        public Task DeleteTodoItem(string id) =&gt; DeleteAsync(id);
    }
}
</code></pre>

<p>Although the attribute is called <code>[Authorize]</code>, this only does authentication.<br />
It does not actually perform authorization.  Authorization is about ensuring
that only certain authorized users can perform actions.  We'll get onto
authorization later on.</p>
<h3 id="social-authentication">Social Authentication</h3>
<p>Azure App Service provides built-in support for Facebook, Google, Microsoft
and Twitter.  Irrespective of whether you intend to use server-flow or
client-flow, you will need to configure the Azure App Service Authentication
service.  In general, the method involves:</p>
<ol>
<li>Obtain a Developer Account for the provider.</li>
<li>Create a new application, obtaining a Client ID and Secret.</li>
<li>Turn on Azure App Service Authentication.</li>
<li>Enter the Client ID and Secret into the specific provider setup.</li>
<li>Save the configuration.</li>
</ol>
<p>Before you start any of this, create a new Azure Mobile Apps as we described
in <a href="../1_introduction/">Chapter 1</a>.  If you want a site to deploy for the configuration, the
<strong>Backend</strong> project in the [Chapter2][10] solution is pre-configured for authorization.
You just need to deploy it to Azure App Service.</p>
<h4 id="facebook-authentication">Facebook Authentication</h4>
<p>I'm going to assume you have a Facebook account already.  If you don't, go to
<a href="https://facebook.com/">Facebook</a> and sign up.  All your friends are likely there already!  Now
log in to the <a href="https://developers.facebook.com/">Facebook Developers</a> web site.  Let's create a new Facebook
application:</p>
<p><img alt="Facebook Developers" src="../img/ch2/fb-dev-1.PNG" /></p>
<p><strong>Note</strong>: Facebook updates the look and feel of their developer site on a regularb
basis.  As a result, the screen shots I've provided here may be different.  If
in doubt, follow the bullet descriptions to find your way.</p>
<blockquote>
<p>If you are not already registered, click on the drop-down in the top-right
corner and <strong>Register as a Developer</strong> before continuing.</p>
</blockquote>
<ul>
<li>Click on the <strong>My Apps</strong> link in the top right corner of the screen.</li>
<li>Click on <strong>Create a New App</strong>.</li>
<li>Fill in the form:</li>
</ul>
<p><img alt="Create a new Application" src="../img/ch2/fb-dev-2.PNG" /></p>
<ul>
<li>
<p>If required, verify your account according to the instructions.  This usually
involves adding a credit card number or verifying your mobile phone number.  </p>
</li>
<li>
<p>Click on the <strong>Get Started</strong> button next to <strong>Facebook Login</strong>.</p>
</li>
</ul>
<p><img alt="Facebook Login" src="../img/ch2/fb-dev-3.PNG" /></p>
<ul>
<li>Enter your application URL + <code>/.auth/login/facebook/callback</code> in the <strong>Valid
OAuth redirect URIs</strong>.</li>
</ul>
<p><img alt="Facebook OAuth redirect URIs" src="../img/ch2/fb-dev-4.PNG" /></p>
<blockquote>
<p>Note that you may not be able to use SSL if you are using the certain plans such
as the F1 Free App  Service Plan.  Some identity providers only allow SSL redirects.<br />
You can upgrade the App Service Plan to a B1 Basic in this case.</p>
</blockquote>
<ul>
<li>Click on <strong>Save Changes</strong>.</li>
<li>Click on the <strong>Settings</strong> -&gt; <strong>Basic</strong> in the left hand side-bar.</li>
<li>Click on the <strong>Show</strong> button next to the App Secret</li>
</ul>
<p>Now that you have the <strong>App ID</strong> and <strong>App Secret</strong>, you can continue configuration
of your app within the <a href="https://portal.azure.com/">Azure Portal</a>.</p>
<ul>
<li>Open up your App Service by clicking on <strong>All Resources</strong> or <strong>App Services</strong>
followed by the name of your app service.</li>
<li>In the <strong>Settings</strong> blade, click on <strong>Authentication / Authorization</strong> which
is under <strong>Features</strong>.</li>
<li>Turn <strong>App Service Authentication</strong> to <strong>On</strong>.</li>
<li>In the <strong>Action to take when request is not authenticated</strong>, select <strong>Allow Request (no action)</strong>.</li>
</ul>
<blockquote>
<p>It's very tempting to choose <strong>Log in with Facebook</strong>.  However, you need to avoid this.  Selecting this option will mean that all requests need to be authenticated and you won't get the information on the back end.  Selecting <strong>Allow Request</strong> means your app is in charge of what gets authenticated and what does not require authentication.</p>
</blockquote>
<ul>
<li>Click on <strong>Facebook</strong> (which should show <em>Not Configured</em>).</li>
<li>Cut and Paste the <strong>App ID</strong> and <strong>App Secret</strong> into the boxes provided.</li>
<li>Select <strong>public_profile</strong> and <strong>email</strong> for Scopes.</li>
</ul>
<blockquote>
<p>Note that if you request anything but public_profile, user_friends, and email, your app will need further review by Facebook, which will take time.  This process is not worth it for test apps like this one.</p>
</blockquote>
<ul>
<li>Click on <strong>OK</strong> (at the bottom of the blade) to close the Facebook configuration blade.</li>
<li>Click on <strong>Save</strong> (at the top of the blade) to save your Authentication changes.</li>
</ul>
<p>You can test your authentication process by browsing to https://<em>yoursite</em>.azurewebsites.net/.auth/login/facebook;
this is the same endpoint that the Azure Mobile Apps Client SDK calls when it is time
to integrate authentication into the mobile client.</p>
<p><img alt="Confirming Facebook Authentication" src="../img/ch2/fb-dev-5.PNG" /></p>
<p>If you are not logged in to facebook already, you will be prompted for your
facebook credentials first.  Finally, here is your happy page - the page that
signifies you have done everything right:</p>
<p><img alt="Authentication Succeeded" src="../img/ch2/auth-success.PNG" /></p>
<h4 id="google-authentication">Google Authentication</h4>
<h3 id="enterprise-authentication">Enterprise Authentication</h3>
<h3 id="what-is-in-a-jwt">What is in a JWT</h3>
<h2 id="implementing-authentication-to-a-mobile-client">Implementing Authentication to a Mobile Client</h2>
<h3 id="social-authentication_1">Social Authentication</h3>
<h3 id="enterprise-authentication_1">Enterprise Authentication</h3>
<h2 id="custom-authentication">Custom Authentication</h2>
<h3 id="azure-active-directory-b2c">Azure Active Directory B2C</h3>
<h3 id="using-third-party-tokens">Using Third-Party Tokens</h3>
<h3 id="using-an-identity-database">Using an Identity Database.</h3>
<h2 id="authorization">Authorization</h2>
<h2 id="refresh-tokens">Refresh Tokens</h2>
<h3 id="configuring-refresh-tokens">Configuring Refresh Tokens</h3>
<h3 id="using-refresh-tokens">Using Refresh Tokens</h3>
<h2 id="logging-out">Logging out</h2>
<h2 id="best-practices">Best Practices</h2>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../3_data/" class="btn btn-neutral float-right" title="3. Data Access and Offline Sync">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../1_introduction/" class="btn btn-neutral" title="1. Your First Mobile App"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../1_introduction/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../3_data/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
